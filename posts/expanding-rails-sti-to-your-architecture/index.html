<!DOCTYPE html>
<html lang=" en-US">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">

  <title>
    
    
    
    Expanding Rails' STI to your architecture -
    
    
    Lucas Arantes
  </title>

  <meta name="description" content="Blog about Ruby, Elixir, command line, text editors, developer productivity, personal projects, etc.">
  <meta name="keywords" content="Blog about Ruby, Elixir, command line, text editors, developer productivity, personal projects, etc.">

  <meta content="Lucas Arantes" property="og:site_name">

  <meta content="Expanding Rails' STI to your architecture" property="og:title">


  <meta content="article" property="og:type">


  <meta content="Blog about Ruby, Elixir, command line, text editors, developer productivity, personal projects, etc." property="og:description">


  <meta content="https://lucasprag.com/posts/expanding-rails-sti-to-your-architecture/" property="og:url">


  <meta content="2020-06-22T00:00:00+00:00" property="article:published_time">
  <meta content="https://lucasprag.com/about/" property="article:author">


  <meta content="https://lucasprag.com/assets/images/computer.png" property="og:image">


  


  
  <meta content="architecture" property="article:tag">
  
  <meta content="rails" property="article:tag">
  


  <link rel="canonical" href="https://lucasprag.com/posts/expanding-rails-sti-to-your-architecture/">
  <link rel="icon" type="image/x-icon" href="https://lucasprag.com/assets/images/favicon.ico">
  <link rel="stylesheet" href="https://lucasprag.com/assets/css/main.css">
  <link rel="alternate" type="application/rss+xml" href="https://lucasprag.com/feed.xml" title="RSS 2.0" />
  <link rel="sitemap" href="https://lucasprag.com/sitemap.xml" type="application/xml" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WTKH1J2E5Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WTKH1J2E5Z');
</script>
</head>

<body class="dark:bg-gray-900"></body>
<div class="container mx-auto max-w-4xl flex flex-col min-h-screen px-4">
  <div class="flex justify-between my-8">
  <a href="/" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 px-4 py-3 rounded">
    <h1 class="font-medium text-xl">
      <img src="/assets/images/computer.png" height="15" width="15" alt="lucasprag emoji" class="inline" />
      <span class="ml-2">lucasprag</span>
    </h1>
  </a>

  <div class="flex justify-end">
    <button class="px-4 pb-3 pt-3 ml-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded" onclick="switchTheme()" aria-label="Switch between dark mode and light mode">
      <!-- Dark Icon  -->
      <svg
        class="align-middle block dark:hidden" height="23" width="23" alt="click to enable dark mode"
        xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" focusable="false" width="1em" height="1em" viewBox="0 0 36 36"><path fill="currentColor" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="currentColor" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>

      <!-- Light Icon -->
      <svg
        class="align-middle hidden dark:block" height="23" width="23" alt="click to enable light mode"
        xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" focusable="false" width="1em" height="1em" viewBox="0 0 36 36"><path fill="currentColor" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="currentColorr"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
    </button>
  </div>
</div>

  <main class="flex-1">
    <h1 class="font-semibold text-3xl">
  Expanding Rails' STI to your architecture
</h1>

<div>
  <time class="font-medium text-sm py-3 text-gray-400">
    
      Published: June 22, 2020
    
  </time>
  <span class="mx-2 text-gray-700 dark:text-gray-400">-</span>

  <div class="text-xs mt-1 inline">
    
    <span class="tag mr-1">
      architecture
    </span>,
    
    <span class="tag mr-1">
      rails
    </span>
    
  </div>
</div>

<div class="post-content prose mt-5">
  <p>Let’s say we need to create integrations with multiple ecommerce platforms that are somewhat similar where all them have orders, customers, products and the store itself, in this scenario we could use one model for each of these entities.</p>

<p>We don’t need to stop there, we could make our software architecture understand when it’s talking to an entity from platform <code class="language-plaintext highlighter-rouge">x</code> versus platform <code class="language-plaintext highlighter-rouge">y</code> and, with that, only implement the nuances of new platforms when adding them. Let me show you one idea.</p>

<h2 id="how-rails-sti-works">How Rails STI works</h2>

<blockquote>
  <p>STI or Single Table Inheritance is a way to simulate object-oriented inheritance in a relational database. - <a href="https://en.wikipedia.org/wiki/Single_Table_Inheritance">Wikipedia</a>.</p>
</blockquote>

<p>What it means is that we can have multiple models inheriting from one model with common methods and attributes and that is linked to a single database table through active record. Let me show you how.</p>

<p>To achieve that, imagine a model called <code class="language-plaintext highlighter-rouge">Store</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/store.rb</span>
<span class="k">class</span> <span class="nc">Store</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="k">def</span> <span class="nf">admin_url</span>
    <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This model has these database columns:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rails g model Store name url external_id:string:uniq</span>

<span class="k">class</span> <span class="nc">CreateStores</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:stores</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:url</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:external_id</span> <span class="c1"># the ID on its platform</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:stores</span><span class="p">,</span> <span class="ss">:external_id</span><span class="p">,</span> <span class="ss">unique: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In order to use STI on this model, we simply need to add a column type to its table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rails g migration AddTypeToStores type data_json:jsonb</span>
<span class="k">class</span> <span class="nc">AddTypeToStores</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">6.0</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:stores</span><span class="p">,</span> <span class="ss">:type</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_column</span> <span class="ss">:stores</span><span class="p">,</span> <span class="ss">:data_json</span><span class="p">,</span> <span class="ss">:jsonb</span><span class="p">,</span> <span class="ss">default: </span><span class="s2">"{}"</span> <span class="c1"># more on this later</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The sub-models:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/store/shopify.rb</span>
<span class="k">class</span> <span class="nc">Store::Shopify</span> <span class="o">&lt;</span> <span class="no">Store</span>
  <span class="k">def</span> <span class="nf">admin_url</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/admin"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/store/bigcommerce.rb</span>
<span class="k">class</span> <span class="nc">Store::Bigcommerce</span> <span class="o">&lt;</span> <span class="no">Store</span>
  <span class="k">def</span> <span class="nf">admin_url</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/manage/dashboard"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For some of these platforms we could have totally unique attributes, thanks to <a href="https://api.rubyonrails.org/classes/ActiveRecord/Store.html"><code class="language-plaintext highlighter-rouge">store_accessor</code></a>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Store::Bigcommerce</span> <span class="o">&lt;</span> <span class="no">Store</span>
  <span class="n">store_accessor</span> <span class="ss">:data_json</span><span class="p">,</span> <span class="ss">:webdav_url</span>

  <span class="k">def</span> <span class="nf">admin_url</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">/manage/dashboard"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The result:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shopify_store</span> <span class="o">=</span> <span class="no">Store</span><span class="o">::</span><span class="no">Shopify</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"My Store"</span><span class="p">,</span> <span class="ss">url: </span><span class="s2">"https://mystore.myshopify.com"</span><span class="p">)</span>
<span class="n">shopify_store</span><span class="p">.</span><span class="nf">name</span>
<span class="n">shopify_store</span><span class="p">.</span><span class="nf">admin_url</span>
<span class="c1"># =&gt; "https://mystore.myshopify.com/admin"</span>

<span class="n">bigcommerce_store</span> <span class="o">=</span> <span class="no">Store</span><span class="o">::</span><span class="no">Bigcommerce</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"My Store"</span><span class="p">,</span> <span class="ss">url: </span><span class="s2">"https://mystore.mybigcommerce.com"</span><span class="p">)</span>
<span class="n">bigcommerce_store</span><span class="p">.</span><span class="nf">name</span>
<span class="n">bigcommerce_store</span><span class="p">.</span><span class="nf">admin_url</span>
<span class="c1"># =&gt; https://mystore.mybigcommerce.com/manage/dashboard</span>

<span class="n">bigcommerce_store</span><span class="p">.</span><span class="nf">webdav_url</span> <span class="o">=</span> <span class="s2">"https://store-570ec032.mybigcommerce.com/dav"</span>
<span class="c1"># =&gt; https://store-570ec032.mybigcommerce.com/dav</span>
</code></pre></div></div>

<p>Note that we don’t have the <code class="language-plaintext highlighter-rouge">webdav_url</code> attribute for Shopify store models:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shopify_store</span><span class="p">.</span><span class="nf">webdav_url</span>
<span class="c1"># NoMethodError (undefined method `webdav_url' for #&lt;Store::Shopify:0x00007fc6a7b848c0&gt;)</span>
</code></pre></div></div>

<p>Lastly, to query the STI model we don’t need to only query it using the specific STI model, the parent model also works.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Store</span><span class="o">::</span><span class="no">Shopify</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"My Store"</span><span class="p">,</span> <span class="ss">url: </span><span class="s2">"https://mystore.myshopify.com"</span><span class="p">)</span>
<span class="no">Store</span><span class="p">.</span><span class="nf">last</span>
<span class="c1">#&lt;Store::Shopify id: 1, name: "My Store", [...], type: "Store::Shopify", data_json: {}&gt;</span>
</code></pre></div></div>

<p>All this ☝️ helps us use similar models that share most of their methods and data but still are able to have some custom methods and attributes based on type.</p>

<h1 id="expanding-to-the-architecture">Expanding to the architecture</h1>

<p>I’m going to use as example a simple architecture based on small classes that respond to <code class="language-plaintext highlighter-rouge">#run</code> and for the sake of this post, I’m only considering the store itself instead of all its possible entities like orders, customers, products, etc.</p>

<p>Use case: fetch and save store data from multiple platform APIs</p>

<p>Usage:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">SyncStore</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="no">Store</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
</code></pre></div></div>

<p>There is no mention of any platform in the code above. Our goal is to not need to worry about platform specific behaviour until we really need. 💪</p>

<p>This is simple, we just need to use some common OOP concepts like inheritance with one catch that I’m going to show you later.</p>

<p>First, we need a parent class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/sync_store.rb</span>
<span class="k">class</span> <span class="nc">SyncStore</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="nf">run</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">attr_accessor</span> <span class="ss">:store</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">store</span><span class="p">:)</span>
    <span class="vi">@store</span> <span class="o">=</span> <span class="n">store</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Second, we need child classes that are going to implement platform specific behaviour:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/sync_store/shopify.rb</span>
<span class="k">class</span> <span class="nc">SyncStore::Shopify</span> <span class="o">&lt;</span> <span class="no">SyncStore</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="c1"># get store data from API</span>
    <span class="c1"># normalize the return</span>
    <span class="c1"># create or update the store</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/operations/sync_store/bigcommerce.rb</span>
<span class="k">class</span> <span class="nc">SyncStore::Bigcommerce</span> <span class="o">&lt;</span> <span class="no">SyncStore</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="c1"># get store data from API</span>
    <span class="c1"># normalize the return</span>
    <span class="c1"># create or update the store</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In order to use the code above we would have to explicitly know about the type in our controllers, background jobs, etc.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">SyncStore</span><span class="o">::</span><span class="no">Shopify</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="no">Store</span><span class="o">::</span><span class="no">Shopify</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
<span class="no">SyncStore</span><span class="o">::</span><span class="no">Bigcommerce</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="no">Store</span><span class="o">::</span><span class="no">Bigcommerce</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
</code></pre></div></div>

<p>This is not what we want, but it’s close.</p>

<p>We can change our parent class to automatically detect what is the type of the first argument and initialize the STI child class for that type.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/sync_store.rb</span>
<span class="k">class</span> <span class="nc">SyncStore</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="nf">run</span> <span class="c1"># changed from calling .new to .build</span>
    <span class="k">end</span>

    <span class="c1"># detect the STI type and initialize the child class</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="c1"># let devs use platform specific classes directly</span>
      <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'::'</span><span class="p">).</span><span class="nf">size</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="c1"># gets the STI type of the object in the first keyword argument</span>
        <span class="c1"># Ex. "Shopify", "Bigcommerce"</span>
        <span class="n">sti_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">demodulize</span>

        <span class="c1"># try to find STI sub class, if not found return itself</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="n">sti_type</span><span class="si">}</span><span class="s2">"</span><span class="p">.</span><span class="nf">safe_constantize</span> <span class="o">||</span> <span class="nb">self</span>

        <span class="n">operation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">attr_accessor</span> <span class="ss">:store</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">store</span><span class="p">:)</span>
    <span class="vi">@store</span> <span class="o">=</span> <span class="n">store</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>All we need it to call the parent class and we don’t even need to know the STI type of the model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">SyncStore</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="no">Store</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
</code></pre></div></div>

<p>Why stop there? We can make most of our other classes understand it and only implement the nuances of each platform when adding a new one.</p>

<p>For that to happen we need to move this logic of choosing the STI child class out to something shared. It could be a common parent class or a shared module between these classes. I’m going with a shared module.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/lib/operation.rb</span>

<span class="k">module</span> <span class="nn">Operation</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
    <span class="n">klass</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ClassMethods</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">ClassMethods</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">).</span><span class="nf">run</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="c1"># let devs use platform specific classes dirrectly</span>
      <span class="k">if</span> <span class="nb">name</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'::'</span><span class="p">).</span><span class="nf">size</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="c1"># gets the STI type of the object in the first keyword argument</span>
        <span class="c1"># Ex. "Shopify", "Bigcommerce"</span>
        <span class="n">sti_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">demodulize</span>

        <span class="c1"># try to find STI sub class, if not found return itself</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">::</span><span class="si">#{</span><span class="n">sti_type</span><span class="si">}</span><span class="s2">"</span><span class="p">.</span><span class="nf">safe_constantize</span> <span class="o">||</span> <span class="nb">self</span>

        <span class="n">operation</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then include this module to all parent classes that we want to do have this behaviour of choosing a child class based on the given STI model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/sync_store.rb</span>
<span class="k">class</span> <span class="nc">SyncStore</span>
  <span class="kp">include</span> <span class="o">::</span><span class="no">Operation</span>

  <span class="nb">attr_accessor</span> <span class="ss">:store</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">store</span><span class="p">:)</span>
    <span class="vi">@store</span> <span class="o">=</span> <span class="n">store</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">normalized_store</span> <span class="o">=</span> <span class="no">NormalizeStore</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="n">store</span><span class="p">,</span> <span class="ss">store_hash: </span><span class="n">get_store_from_api</span><span class="p">)</span>

    <span class="no">SaveStore</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="n">store</span><span class="p">,</span> <span class="ss">normalized_store: </span><span class="n">normalized_store</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">get_store_from_api</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">get_store_from_api</code> method should be implemented on every STI child class.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/sync_store/shopify.rb</span>
<span class="k">class</span> <span class="nc">SyncStore::Shopify</span> <span class="o">&lt;</span> <span class="no">SyncStore</span>
  <span class="k">def</span> <span class="nf">get_store_from_api</span>
    <span class="c1"># call API and get this result</span>
    <span class="p">{</span> <span class="ss">store_name: </span><span class="s2">"My Shopify Store"</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/operations/sync_store/bigcommerce.rb</span>
<span class="k">class</span> <span class="nc">SyncStore::Bigcommerce</span> <span class="o">&lt;</span> <span class="no">SyncStore</span>
  <span class="k">def</span> <span class="nf">get_store_from_api</span>
    <span class="c1"># call API and get this result</span>
    <span class="p">{</span> <span class="ss">display_name: </span><span class="s2">"My BigCommerce Store"</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note the difference between the returned payloads. (Having <code class="language-plaintext highlighter-rouge">store_name</code> and <code class="language-plaintext highlighter-rouge">display_name</code> for name)</p>

<p>We can do the same thing with <code class="language-plaintext highlighter-rouge">NormalizeStore</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/normalize_store.rb</span>
<span class="k">class</span> <span class="nc">NormalizeStore</span>
  <span class="kp">include</span> <span class="o">::</span><span class="no">Operation</span>

  <span class="nb">attr_accessor</span> <span class="ss">:store</span><span class="p">,</span> <span class="ss">:store_hash</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">store</span><span class="p">:,</span> <span class="n">store_hash</span><span class="p">:)</span>
    <span class="vi">@store</span> <span class="o">=</span> <span class="n">store</span>
    <span class="vi">@store_hash</span> <span class="o">=</span> <span class="n">store_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="k">raise</span> <span class="no">NotImplementedError</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/operations/normalize_store/shopify.rb</span>
<span class="k">class</span> <span class="nc">NormalizeStore::Shopify</span> <span class="o">&lt;</span> <span class="no">NormalizeStore</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="c1"># converts Shopify's store_hash to a common hash to assign to the model</span>
    <span class="p">{</span> <span class="ss">name:  </span><span class="n">store_hash</span><span class="p">[</span><span class="ss">:store_name</span><span class="p">]</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/operations/normalize_store/bigcommerce.rb</span>
<span class="k">class</span> <span class="nc">NormalizeStore::Bigcommerce</span> <span class="o">&lt;</span> <span class="no">NormalizeStore</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="c1"># converts BigCommerce's store_hash to a common hash to assign to the model</span>
    <span class="p">{</span> <span class="ss">name: </span><span class="n">store_hash</span><span class="p">[</span><span class="ss">:display_name</span><span class="p">]</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>But on <code class="language-plaintext highlighter-rouge">SaveStore</code> we don’t have any specific platform behaviour to cover since we have a common hash representing the store, we can just assign what we want and save.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/operations/save_store.rb</span>
<span class="k">class</span> <span class="nc">SaveStore</span>
  <span class="kp">include</span> <span class="o">::</span><span class="no">Operation</span>

  <span class="nb">attr_accessor</span> <span class="ss">:store</span><span class="p">,</span> <span class="ss">:normalized_store</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">store</span><span class="p">:,</span> <span class="n">normalized_store</span><span class="p">:)</span>
    <span class="vi">@store</span> <span class="o">=</span> <span class="n">store</span>
    <span class="vi">@normalized_store</span> <span class="o">=</span> <span class="n">normalized_store</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">store</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">normalized_store</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you’re following these instructions on your own, don’t forget to add these new directories to your <code class="language-plaintext highlighter-rouge">config/application.rb</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">+=</span> <span class="sx">%W(</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="sx">/operations/**/*.rb)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">+=</span> <span class="sx">%W(</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="sx">/lib/*.rb)</span>
</code></pre></div></div>

<p>It’s done, we can test in the Rails console.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create some data</span>
<span class="no">Store</span><span class="o">::</span><span class="no">Shopify</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"To be updated"</span><span class="p">,</span> <span class="ss">url: </span><span class="s2">"https://mystore.myshopify.com"</span><span class="p">)</span>

<span class="c1"># run the parent class</span>
<span class="no">SyncStore</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="no">Store</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>

<span class="no">Store</span><span class="p">.</span><span class="nf">last</span>
<span class="c1"># =&gt; #&lt;Store::Shopify id: 1, name: "My Shopify Store", type: "Store::Shopify", ...&gt;</span>
</code></pre></div></div>

<h1 id="validating-the-architecture">Validating the architecture</h1>

<p>The goal for this architecture is to be able to only implement the nuances of new platforms as we add them. Let’s validate that by adding a new platform: <strong>Wix</strong>.</p>

<p>There are three classes we need to implement to be able to sync a Wix store: <code class="language-plaintext highlighter-rouge">Store::Wix</code>, <code class="language-plaintext highlighter-rouge">SyncStore::Wix</code> and <code class="language-plaintext highlighter-rouge">NormalizeStore::Wix</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/store/wix.rb</span>
<span class="k">class</span> <span class="nc">Store::Wix</span> <span class="o">&lt;</span> <span class="no">Store</span>
  <span class="k">def</span> <span class="nf">admin_url</span>
    <span class="s2">"https://www.wix.com/dashboard/</span><span class="si">#{</span><span class="n">external_id</span><span class="si">}</span><span class="s2">/home"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/operations/sync_store/wix.rb</span>
<span class="k">class</span> <span class="nc">SyncStore::Wix</span> <span class="o">&lt;</span> <span class="no">SyncStore</span>
  <span class="k">def</span> <span class="nf">get_store_from_api</span>
    <span class="p">{</span> <span class="ss">site: </span><span class="p">{</span> <span class="ss">displayName: </span><span class="s2">"My Wix Store"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/operations/normalize_store/wix.rb</span>
<span class="k">class</span> <span class="nc">NormalizeStore::Wix</span> <span class="o">&lt;</span> <span class="no">NormalizeStore</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="c1"># converts Wix's store_hash to a common hash to assign to the model</span>
    <span class="p">{</span> <span class="ss">name: </span><span class="n">store_hash</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:site</span><span class="p">,</span> <span class="ss">:displayName</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Trying it out:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># create some data</span>
<span class="no">Store</span><span class="o">::</span><span class="no">Wix</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"To be updated"</span><span class="p">,</span> <span class="ss">url: </span><span class="s2">"https://store.lucasprag.com/"</span><span class="p">)</span>

<span class="c1"># run the parent class</span>
<span class="no">SyncStore</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">store: </span><span class="no">Store</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>

<span class="no">Store</span><span class="p">.</span><span class="nf">last</span>
<span class="c1"># =&gt; #&lt;Store::Wix id: 3, name: "My Wix Store", type: "Store::Wix", ...&gt;</span>
</code></pre></div></div>

<p>We reached our goal of only implementing the nuances of this new platform. ✅</p>

<h1 id="the-end-result">The end result</h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tree app/models/

app/models
├── application_record.rb
├── concerns
├── store
│   ├── bigcommerce.rb
│   ├── shopify.rb
│   └── wix.rb
└── store.rb
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tree app/operations/

app/operations/
├── normalize_store     # converts platform specific data to common data
│   ├── bigcommerce.rb
│   ├── shopify.rb
│   └── wix.rb
├── normalize_store.rb
├── save_store.rb       # updates store based on common data
├── sync_store          # implements method to call the platform's specific API
│   ├── bigcommerce.rb
│   ├── shopify.rb
│   └── wix.rb
└── sync_store.rb       # calls method to call API, calls NormalizeStore and SaveStore
</code></pre></div></div>

<p>You can find the complete code from this post <a href="https://github.com/lucasprag/expanding-sti">here</a>.</p>

<p>I hope you enjoyed this post, please ping on twitter if you have any question, suggestion or just say hi. 👋</p>

<p><small>
  “What about validations?” you may ask, well, I can write a blog post about it, ping on twitter if you want to see my approach for that 👍
</small></p>

</div>
  </main>
  <footer class="mt-8">
  <div class="flex justify-center">
    <a href="https://github.com/lucasprag"
      aria-label="Visit my Github profile"
      class="px-4 pb-3 pt-4 ml-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded" target="_blank">
      <!-- Github Icon -->
      <svg class="align-middle" height="25" width="25" alt="my github profile" xmlns="http://www.w3.org/2000/svg"
        focusable="false" width="25" height="25" viewBox="0 0 25 25" fill="currentColor">
        <path
          d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
      </svg>
    </a>

    <a href="/feed.xml" class="px-4 pb-3 pt-4 ml-1 hover:bg-gray-100 dark:hover:bg-gray-800 rounded"
      aria-label="Link to feed RSS"
      target="_blank">
      <!-- RSS Icon -->
      <svg class="align-middle" height="25" width="25" alt="my RSS feed" xmlns="http://www.w3.org/2000/svg"
        focusable="false" viewBox="0 0 448 512">
        <path fill="currentColor"
          d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM96 136c0-13.3 10.7-24 24-24c137 0 248 111 248 248c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200c-13.3 0-24-10.7-24-24zm0 96c0-13.3 10.7-24 24-24c83.9 0 152 68.1 152 152c0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104c-13.3 0-24-10.7-24-24zm64 120c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32z" />
      </svg>
    </a>
  </div>

  <div class="my-4 text-gray-500 text-xs flex justify-center">
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
      <img alt="Creative Commons License" src="/assets/images/creativecommons-88x31.png" width="88" height="31" />
    </a>
  </div>
</footer>
</div>

<script src="https://lucasprag.com/assets/js/main.js"></script>

<!-- 100% privacy-first analytics -->
<script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
<noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt=""
    referrerpolicy="no-referrer-when-downgrade" /></noscript>
</body>

</html>